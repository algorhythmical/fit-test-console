<!doctype html>
<html lang="en">
<head>
    <style>
        table {
            border-collapse: collapse;
        }

        table th {
            padding: 0.5rem;
            border-bottom: 5px solid black;
            border-left: 2px solid black;
        }

        th {
            position: sticky;
            top: 0;
            background-color: white;
            border-bottom: 5px solid black;
        }

        table td {
            padding: 0.5rem;
            border: 2px solid black;
        }

        table th:last-child {
            border-right: 2px solid black;
        }

        div.editable-table-cell {
            display: inline-block;
            outline: none;
        }

        td.results {
            text-align: end;
        }

        td.pass {
            background-color: green;
            color: white;
        }

        td.fail {
            background-color: darkred;
            color: white;
        }

        td.aborted {
            background-color: gray;
            text-align: center;
        }
    </style>
</head>
<body>
<section>
    <fieldset style="max-width:fit-content; float:left">
        <legend>Baud Rate</legend>
        <select id="baud-rate-selector">
            <option value="300">300</option>
            <option value="600">300</option>
            <option value="1200" selected="selected">1200 (default)</option>
            <option value="2400">2400</option>
            <option value="9600">9600</option>
        </select>
    </fieldset>
    <fieldset style="max-width:fit-content; float:left">
        <legend>Data Source</legend>
        <select id="data-source-selector">
            <option value="ftdi">FTDI</option>
            <option value="web-serial" selected="selected">WebSerial</option>
            <option value="simulator">Simulator</option>
        </select>
        <input type="button" value="Connect" id="connect-button">
    </fieldset>
    <fieldset style="max-width:fit-content; float:left">
        <legend>Options</legend>
        <div style="display:inline-block">
            <input type="checkbox" id="enable-speech-checkbox">
            <label for="enable-speech-checkbox">Enable Speech</label>
        </div>
        <div style="display:inline-block">
            <input type="checkbox" id="enable-verbose-speech-checkbox">
            <label for="enable-verbose-speech-checkbox">Verbose</label>
        </div>
        <div style="display:inline-block">
            <input type="checkbox" id="speak-concentration-checkbox">
            <label for="speak-concentration-checkbox">Say particle count</label>
        </div>
    </fieldset>
    <fieldset style="max-width:fit-content; float:left">
        <legend>Download Data</legend>
        <select id="download-file-format-selector">
            <option value="raw">Raw</option>
            <option value="csv" selected="selected">CSV</option>
            <option value="json">JSON</option>
        </select>
        <input type="button" value="Download!" id="download-button">
    </fieldset>
<!--    <fieldset style="max-width:fit-content; float:right">-->
<!--        <legend>Secret Menu</legend>-->
<!--        <input type="button" value="simulate" id="use-fake-data-button">-->
<!--&lt;!&ndash;        <input type="button" value="probe serial" id="serial-probe-button">&ndash;&gt;-->
<!--        &lt;!&ndash;<input type="button" value="stop monitor" id="stop-monitor-button">&ndash;&gt;-->
<!--    </fieldset>-->
    <!--<fieldset>-->
    <!--    <legend></legend>-->
    <!--    <span>chrome://device-log/?types=Serial</span>-->
    <!--</fieldset>-->
</section>
<br/>
<section>
    <fieldset>
        <legend>Instructions</legend>
        <div id="instructions" style="width:80vw;height:7vh;font-size:xxx-large; overflow:auto; resize: both"></div>
    </fieldset>
</section>
<section id="collected-data">
    <fieldset>
        <legend>Test Info</legend>
        <div id="data-table-div" style="height: 20vh;overflow: auto; resize: both">
            <table id="fit-test-data-table">
                <thead>
                <tr id="test-data-header-row">
                    <th>#</th>
                    <th>Time</th>
                    <th>Participant</th>
                    <th>Mask</th>
                </tr>
                </thead>
                <tbody id="test-data-body">

                </tbody>
            </table>
        </div>
    </fieldset>
</section>
<fieldset style="float:left">
    <legend>Raw Data</legend>
    <textarea id="raw-data" readonly style="width:300px;height:200px" tabindex="1000"></textarea>
</fieldset>
<fieldset style="float:left">
    <legend>Processed Data</legend>
    <textarea id="interpreted-data" readonly style="width:300px;height:200px" tabindex="1001"></textarea>
</fieldset>
<fieldset style="float:left">
    <legend>Log</legend>
    <textarea id="log-text-area" readonly style="width:90vw;height:200px" tabindex="1002"></textarea>
</fieldset>

<!--<script type="module" src="mock-portacount-data-source.js"></script>-->
<!--<script type="module" src="data-collector.js"></script>-->
<script type="module" >
    // import {setup} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/main.js";
    import {DataCollector} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/data-collector.js";
    import {quickSetupSpeechSynthesis} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/speech.js";
    import {downloadRawData, downloadTableAsCSV, downloadTableAsJSON} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/html-data-downloader.js";
    import {FtdiSerial} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/webusb-ftdi-data-source.js";
    import {DataFilePushSource, getLines, getReadableStreamFromDataSource} from "https://cdn.jsdelivr.net/gh/emcee5601/fit-test-console@main/src/datasource-helpers.js";

    const baudRateSelector = document.getElementById("baud-rate-selector")
    const logTextArea = document.getElementById("log-text-area")
    const rawDataTextArea = document.getElementById("raw-data")
    const dataTextArea = document.getElementById("interpreted-data")
    const instructionsTextArea = document.getElementById("instructions");


    let connectedPort;
    let reader;
    let readableStreamClosed;
    let writer;
    let writableStreamClosed;
    const dataCollector = new DataCollector(logTextArea, dataTextArea, instructionsTextArea);

    function logit(message) {
        console.log(message);
        dataCollector.appendToLog(message);
    }


    function serialProbe() {
        console.log("serialProbe...");
        if ("serial" in navigator) {
            logit("serial supported!")
        } else {
            logit("no serial support :(")
        }
        let promise = navigator.serial.getPorts().then((ports) => {
            let message = `got serial ports: ${ports.toString()}`;
            logit(message)
        })
    }

    function serialRequest() {
        const baudRate = baudRateSelector.value;

        if ("serial" in navigator) {
            logit("serial supported!")
        } else {
            logit("no serial support. As of this writing, web serial is only supported on desktop chrome.")
        }

        let promise = navigator.serial.requestPort().then((port) => {
            logit(`got serial port ${port.toLocaleString()}, using baud rate ${baudRate}`)
            port.open({baudRate: baudRate}).then((event) => {
                logit(`opened ${event}`)
                monitor(port.readable.getReader());
            })
        })
    }

    function ftdiRequest() {
        const baudRate = baudRateSelector.value;
        const serial = new FtdiSerial();
        serial.requestPort().then((port) => {
            port.open({baudRate: baudRate}).then((event) => {
                logit(`ftdi opened ${event}`)
                monitor(port.readable.getReader());
            })
        })
    }

    function autodetectBaudRate() {
        // according to the 8020 technical manual, everything is N81
        // factory setting is 1200
        // supported values are 300, 600, 1200, 2400, 9600

    }


    // use simulator as data source
    function simulatorRequest() {
        const fakeReader = getReadableStreamFromDataSource(new DataFilePushSource("/src/test-data.txt")).getReader();
        monitor(fakeReader);
    }

    function setupButtons() {

        const connectButton = document.getElementById("connect-button");
        connectButton.onclick = (event) => {
            const selectedDataSource = document.getElementById("data-source-selector").value
            switch( selectedDataSource) {
                case "ftdi":
                    ftdiRequest();
                    break;
                case "web-serial":
                    serialRequest();
                    break;
                case "simulator":
                    simulatorRequest();
                    break;
                default:
                    logit(`Unsupported data source: ${selectedDataSource}`);
            }
        }

        const downloadButton = document.getElementById("download-button");
        downloadButton.onclick = (event) => {
            const table = document.getElementById("fit-test-data-table");
            const selector = document.getElementById("download-file-format-selector");
            switch (selector.value) {
                case "raw":
                    downloadRawData(rawDataTextArea);
                    break;
                case "csv":
                    downloadTableAsCSV(table);
                    break;
                case "json":
                    downloadTableAsJSON(table);
                    break;
                default:
                    console.log(`unsupported download file format: ${selector.value}`);
            }
        }


        // const stop_monitor_button = document.getElementById("stop-monitor-button");
        // stop_monitor_button.onclick = (event) => {
        //     stopMonitor();
        // }
    }

    function appendRaw(message) {
        rawDataTextArea.value += message;
        DataCollector.scrollToBottom(rawDataTextArea);
    }



    async function monitor(reader) {
        for await (let line of getLines(reader)) {
            appendRaw(`${line}\n`); // not really raw anymore since we've re-chunked into lines.
            dataCollector.processLine(line);
        }
    }


    const onConnect = function (event) {
        console.log(`connected ${event}`)
        connectedPort = event.target;
        monitor(connectedPort);
    };


    function setupMonitor() {
        navigator.serial.addEventListener('connect', onConnect)
    }


    async function stopMonitor() {
        logit("stopping monitor")
        const textEncoder = new TextEncoderStream();
        writer = textEncoder.writable.getWriter();
        writableStreamClosed = textEncoder.readable.pipeTo(connectedPort.writable);

        reader.cancel();
        await readableStreamClosed.catch(() => { /* Ignore */
        });

        await writer.close();
        await writableStreamClosed;

        await connectedPort.close();
    }

    function maybeAutoConnect() {
        let promise = navigator.serial.getPorts().then((ports) => {
            let message = `got serial ports: ${ports.toString()}`;
            if (ports.length === 1) {
                logit("found 1 serial port, attempting to auto-connect...")
                const baudRate = baudRateSelector.value;
                const port = ports[0];
                port.open({baudRate: baudRate}).then((event) => {
                    logit(`opened ${event}`)
                    monitor(port.readable.getReader());
                })
            }
        })

    }

    function setup() {
        quickSetupSpeechSynthesis();
        setupButtons();
        setupMonitor();

        // maybeAutoConnect();
        // protect against un/reload most of the time
        window.addEventListener("beforeunload", (event) => {
            event.preventDefault();
        });
    }

    setup();

</script>
</body>
</html>
